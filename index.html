<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vaporwave Calculator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background-color: black;
      color: white;
      margin: 0;
      overflow: hidden;
    }

    #bg-grid {
      position: fixed;
      inset: 0;
      z-index: -1;
      background: url('./background_gif.gif') center/cover no-repeat;
      opacity: 0.25;
      filter: blur(2px);
    }

    .input-bar {
      background-color: #2d2d2d;
      border-radius: 9999px;
      padding: 0.75rem 1rem;
      outline: none;
      color: white;
      width: 100%;
    }

    .input-bar::placeholder {
      color: #aaa;
    }

    canvas {
      border-radius: 1rem;
    }

    .btn {
      background-color: #333;
      border-radius: 0.5rem;
      padding: 0.75rem;
      text-align: center;
      font-size: 1.25rem;
      transition: background 0.2s;
    }

    .btn:hover {
      background-color: #555;
    }

    .spotify-player {
      font-size: 0.875rem;
    }
  </style>
</head>
<body>
  <div id="bg-grid"></div>

  <div class="flex flex-col h-screen justify-between p-6">
    <!-- Główna zawartość -->
    <div class="flex-grow flex justify-center gap-6 pb-20">
      <!-- Kalkulator -->
      <div class="w-[40%] flex flex-col gap-4 justify-center">
        <!-- Pasek wyniku -->
        <div id="display" class="input-bar text-green-400 text-3xl">0</div>

        <!-- Klawiatura -->
        <div class="grid grid-cols-4 gap-2 text-white">
          <button class="btn">7</button>
          <button class="btn">8</button>
          <button class="btn">9</button>
          <button class="btn">/</button>

          <button class="btn">4</button>
          <button class="btn">5</button>
          <button class="btn">6</button>
          <button class="btn">*</button>

          <button class="btn">1</button>
          <button class="btn">2</button>
          <button class="btn">3</button>
          <button class="btn">-</button>

          <button class="btn">0</button>
          <button class="btn">.</button>
          <button class="btn">=</button>
          <button class="btn">+</button>

          <button class="btn">C</button>
          <button class="btn">^</button>
          <button class="btn">(</button>
          <button class="btn">)</button>
        </div>

        <!-- Pasek do wpisywania funkcji -->
        <input id="functionInput" type="text" class="input-bar text-white" placeholder="enter function" />
      </div>

      <!-- Wykres -->
      <div class="w-[30%] aspect-square">
        <canvas id="graphCanvas" class="bg-black w-full h-full"></canvas>
      </div>
    </div>

    <!-- Pasek muzyki -->
    <div class="fixed bottom-2 left-1/2 -translate-x-1/2 w-1/3 bg-black bg-opacity-80 px-4 py-2 flex items-center justify-between rounded-full spotify-player border border-white">
      <div class="flex gap-4 items-center">
        <button onclick="prevTrack()"><<</button>
        <button onclick="toggleMute()" id="muteBtn">mute</button>
      </div>
      <marquee class="text-white w-full text-center mx-4" id="trackTitle">Loading track...</marquee>
      <button onclick="nextTrack()">>></button>
    </div>
  </div>

  <script>
    const display = document.getElementById('display');
    const buttons = document.querySelectorAll('.btn');
    const functionInput = document.getElementById('functionInput');
    let input = '';

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const val = btn.textContent;
        if (val === 'C') input = '';
        else if (val === '=') {
          try {
            input = eval(input).toString();
          } catch {
            input = 'ERROR';
          }
        } else {
          input += val;
        }
        display.textContent = input || '0';
      });
    });

    function insertMultiplication(str) {
      return str.replace(/(\d)([a-zA-Z])/g, '$1*$2')
                .replace(/([a-zA-Z])(\d)/g, '$1*$2')
                .replace(/([a-zA-Z])([a-zA-Z])/g, '$1*$2');
    }

    const canvas = document.getElementById('graphCanvas');
    const ctx = canvas.getContext('2d');

    function resizeCanvas() {
      canvas.width = canvas.clientWidth;
      canvas.height = canvas.clientHeight;
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    function drawAxes() {
      ctx.strokeStyle = 'white';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(0, canvas.height / 2);
      ctx.lineTo(canvas.width, canvas.height / 2);
      ctx.moveTo(canvas.width / 2, 0);
      ctx.lineTo(canvas.width / 2, canvas.height);
      ctx.stroke();

      ctx.fillStyle = 'white';
      ctx.font = '12px monospace';
      ctx.fillText('x', canvas.width - 10, canvas.height / 2 - 5);
      ctx.fillText('y', canvas.width / 2 + 5, 10);
    }

    // Rozwiązywanie równań i obsługa wielu rozwiązań
    function solveForYAll(expr, xVal) {
      // Jeżeli jest y=..., liczymy bezpośrednio
      if (/y\s*=/.test(expr)) {
        let rhs = expr.split('=').pop();
        return [math.evaluate(rhs, { x: xVal })];
      }

      const equationParts = expr.split('=');
      if (equationParts.length !== 2) return [];

      const left = equationParts[0];
      const right = equationParts[1];
      function F(yVal) {
        return math.evaluate(left, { x: xVal, y: yVal }) - math.evaluate(right, { x: xVal, y: yVal });
      }

      let solutions = [];
      let guesses = [-5, -2, 0, 2, 5]; // różne punkty startowe
      guesses.forEach(start => {
        let yGuess = start;
        for (let i = 0; i < 30; i++) {
          const fVal = F(yGuess);
          const h = 1e-6;
          const derivative = (F(yGuess + h) - F(yGuess - h)) / (2 * h);
          if (Math.abs(derivative) < 1e-10) break;
          yGuess = yGuess - fVal / derivative;
        }
        if (Math.abs(F(yGuess)) < 1e-4) {
          if (!solutions.some(s => Math.abs(s - yGuess) < 0.05)) {
            solutions.push(yGuess);
          }
        }
      });
      return solutions;
    }

    function drawFunction(expr) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawAxes();
      ctx.lineWidth = 2;

      for (let px = 0; px < canvas.width; px++) {
        const x = (px - canvas.width / 2) / 20;
        let yValues;
        try {
          if (expr.includes('=')) {
            yValues = solveForYAll(expr, x);
          } else {
            yValues = [math.evaluate(expr, { x })];
          }
          yValues.forEach(y => {
            ctx.strokeStyle = ['#00ffff', '#ff00ff', '#00ff00', '#ffff00'][Math.floor(Math.random() * 4)];
            ctx.beginPath();
            ctx.lineTo(px, canvas.height / 2 - y * 20);
            ctx.stroke();
          });
        } catch {}
      }
    }

    function renderDefaultMessage() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = 'white';
      ctx.font = '16px monospace';
      ctx.textAlign = 'center';
      ctx.fillText('enter a function or equation', canvas.width / 2, canvas.height / 2);
    }

    functionInput.addEventListener('input', () => {
      const raw = functionInput.value.trim().toLowerCase();
      if (!raw) {
        renderDefaultMessage();
        return;
      }
      const expr = insertMultiplication(raw);
      try {
        drawFunction(expr);
      } catch {
        renderDefaultMessage();
      }
    });

    window.addEventListener('load', renderDefaultMessage);

    const tracks = [
      { title: 'Vaporwave 1 Hour', embed: 'https://www.youtube.com/embed/4xDzrJKXOOY?autoplay=1' },
      { title: 'Lo-Fi Chill Vaporwave Mix', embed: 'https://www.youtube.com/embed/f02mOEt11OQ?autoplay=1' }
    ];
    let currentTrack = 0;
    let muted = false;

    function loadTrack() {
      document.getElementById('trackTitle').textContent = tracks[currentTrack].title;
      let iframe = document.getElementById('yt-iframe');
      if (!iframe) {
        iframe = document.createElement('iframe');
        iframe.id = 'yt-iframe';
        iframe.style.display = 'none';
        iframe.allow = 'autoplay';
        document.body.appendChild(iframe);
      }
      const muteParam = muted ? 'mute=1' : 'mute=0';
      iframe.src = tracks[currentTrack].embed + '&' + muteParam;
    }
    function nextTrack() { currentTrack = (currentTrack + 1) % tracks.length; loadTrack(); }
    function prevTrack() { currentTrack = (currentTrack - 1 + tracks.length) % tracks.length; loadTrack(); }
    function toggleMute() { muted = !muted; document.getElementById('muteBtn').textContent = muted ? 'volume' : 'mute'; loadTrack(); }
    loadTrack();
  </script>
</body>
</html>
